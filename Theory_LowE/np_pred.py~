import numpy as np
from numpy import ma
import matplotlib.pyplot as plt
from collections import OrderedDict
import matplotlib.patches as patches
import scipy.integrate as integrate
import flavio
import flavio.plots as fpl
from matplotlib import rc
from pypet import Environment, cartesian_product
import P5p_anomaly
import FFcorrScan

SM_results = P5p_anomaly.P5p_binned()
#print(SM_results)

bins = [(0.1, 0.98), (1.1, 2.5), (2.5, 4.), (4., 6.)]

# LHCb measurements for bins
ExpMeasur = [0.387, 0.289, -0.066, -0.3]
ExpBarMax = [0.184, 0.243, 0.366, 0.181]
ExpBarMin = [0.185, 0.225, 0.387, 0.182]

SMpred = [0.5548283003349903, 0.17340935839561167, -0.4557726898506839, -0.8304419637589194]
SMpredMaxMin = FFcorrScan.FindMaxMin()
print( SM_results)

def FindErrBar():
    bar_max = []
    bar_min = []
    for i in range(len(SMpredMaxMin[0])):
        bar_max.append( np.absolute(SMpredMaxMin[0][i] - SMpred[i]))
        bar_min.append( np.absolute(SMpred[i] - SMpredMaxMin[1][i]))
    return(bar_max, bar_min) #return list of max err bar and min err bar
#for i in range(len(FindErrBar())):
#    print(FindErrBar()[i])

def FindNPpred():
    Difference = []
    MaxErrBar = []
    MinErrBar = []
    for i in range(len(ExpMeasur)):
        diff = ExpMeasur[i] - SMpred[i]
        Difference.append(diff)
        err_max = np.sqrt(ExpBarMax[i]**2 + FindErrBar()[0][i]**2)
        MaxErrBar.append(err_max)
        err_min = np.sqrt(ExpBarMin[i]**2 + FindErrBar()[1][i]**2)
        MinErrBar.append(err_min)
    return(Difference, MaxErrBar, MinErrBar)

#for i in range(len(bins)):
#    print('%i bin' %i, 'Diff',  FindNPpred()[0][i], ' ', 'Errmax' , FindNPpred()[1][i], ' ', 'Errmin' , FindNPpred()[2][i])
    


# Bin Plot with error bars

def BinPlot():
    rc('font',**{'family':'serif','serif':['Palatino']})
    rc('text', usetex=True)
    
    bins=[(0.1, 0.98),(1.1, 2.5), (2.5, 4.), (4., 6.0)]
    #bins.tolist() #needed for Flavio th-prediction
    bins=[tuple(entry) for entry in bins]
    
    
    Max_plt = np.array(FindNPpred()[1])
    Max_plt = np.append(Max_plt, -1)
    Min_plt = np.array(FindNPpred()[2])
    Min_plt = np.append(Min_plt, -1)
    Central_plt = np.array(FindNPpred()[0])
    Central_plt = np.append(Central_plt, -1)
    
    ax=plt.gca()
    ax.set_xlim([0, 6.1])
    ax.set_ylim([-1, 1.])
    for i in range(len(bins)):
        label= 'SM-th'
        if i>0:
            label=None
        ax.add_patch(patches.Rectangle((bins[i][0], (Central_plt[i]-Min_plt[i])),
                                       bins[i][1]-bins[i][0],          # width
                                       (Max_plt[i] + Min_plt[i]),   # height
                                       ec='c', fill= False, lw=True, hatch= '///',
                                       label=label, capstyle= 'butt'))
            
            # Falvio experimental data
    measur=['LHCb B->K*mumu 2015 P 0.1-0.98',
            'LHCb B->K*mumu 2015 P 1.1-2.5',
            'LHCb B->K*mumu 2015 P 2.5-4',
            'LHCb B->K*mumu 2015 P 4-6']
    #'ATLAS B->K*mumu 2017 P5p' ]
   # fpl.bin_plot_exp('<P5p>(B0->K*mumu)',
    #                 col_dict= {'ATLAS': 'c', 'LHCb': 'y' },  #'#EB70AA' for light pink
     #                divide_binwidth=False,
      #               include_measurements=measur)
    
    # Flavio theoretical prediction
    #fpl.bin_plot_th( '<P5p>(B0->K*mumu)', bins,
    #                 label='SM-th-Flavio', divide_binwidth=False,
    #                N=50,threads=2)
    
    plt.xlabel('$q^2 \hspace{2pt} (GeV^2)$')
    plt.ylabel('$P5\' \hspace{2pt} (q^2)$')
    plt.legend()
    #plt.title('$SM$' ''prediction)
    #plt.title('$P_5\'$ prediction with $ (\delta C_7, \delta C_9, \delta C_{10}) = (.1, .1, .1)$')
    plt.show()
    #plt.ylim(-1.2, 0.7)
    #plt.savefig('Fig1_NewP5.png', bbox_inches='tight')
    return(0)

#BinPlot()


'''
0 bin Diff -0.1678283003349903   Errmax 0.1842725321112186   Errmin 0.1852605084985456
1 bin Diff 0.11559064160438831   Errmax 0.24902416973200706   Errmin 0.23080052775962512
2 bin Diff 0.3897726898506839   Errmax 0.37621471813207163   Errmin 0.39327243391740074
3 bin Diff 0.5304419637589195   Errmax 0.18539231373131373   Errmin 0.18410547676496747
'''
